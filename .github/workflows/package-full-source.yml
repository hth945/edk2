name: Package Source + Submodules â†’ Release (No History)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      notes:
        description: 'Release notes (optional)'
        required: false

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»ï¼ç”¨äºåˆ›å»º GitHub Release

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1  # æµ…å…‹éš†ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: Remove all Git-related files and directories
        run: |
          echo "ğŸ—‘ï¸ Removing .git directories and Git config files..."
          # åˆ é™¤ä¸»ä»“åº“å’Œå­æ¨¡å—çš„ .git ç›®å½•
          rm -rf .git
          find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          # åˆ é™¤ Git é…ç½®æ–‡ä»¶ï¼ˆç”¨æˆ·ä¸éœ€è¦ï¼‰
          rm -f .gitmodules .gitignore .gitattributes .mailmap

      - name: Show directory structure BEFORE packing
        run: |
          echo "ğŸ” Files and folders that will be packed:"
          ls -laR

      - name: Create clean source archive safely
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          TAG="${{ github.event.inputs.tag }}"
          # æ¸…ç† tag ä¸­çš„éæ³•å­—ç¬¦ï¼ˆå¦‚ /, #, ç©ºæ ¼ç­‰ï¼‰
          SAFE_TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]/-/g')
          ARCHIVE_NAME="${REPO_NAME}-${SAFE_TAG}.tar.gz"

          echo "ğŸ“¦ Creating archive: $ARCHIVE_NAME"

          # ç­‰å¾… 2 ç§’ï¼Œç¡®ä¿æ— åå°å†™å…¥
          sleep 2

          # åˆ›å»ºä¸´æ—¶å¹²å‡€å‰¯æœ¬
          mkdir -p /tmp/clean-repo
          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitmodules' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='.editorconfig' \
            --exclude='.vscode' \
            --exclude='.idea' \
            --exclude='.devcontainer' \
            --exclude='.azurepipelines' \
            --exclude='.mergify' \
            --exclude='.pytool' \
            --exclude='.env' \
            --exclude='.DS_Store' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='build' \
            --exclude='dist' \
            --exclude='*.log' \
            --exclude='Thumbs.db' \
            . /tmp/clean-repo/

          # è¿›å…¥ä¸´æ—¶ç›®å½•ï¼Œæ‰“åŒ…å¹¶æ·»åŠ é¡¶å±‚ç›®å½•å
          cd /tmp/clean-repo
          tar --transform "s,^,${REPO_NAME}-${SAFE_TAG}/," -czf "../$ARCHIVE_NAME" .

          # ç§»å›åŸå·¥ä½œåŒº
          mv "../$ARCHIVE_NAME" .

          echo "âœ… Archive created successfully."

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: Release ${{ github.event.inputs.tag }}
          body: ${{ github.event.inputs.notes || 'Automated source package with submodules (no Git history)' }}
          files: "*.tar.gz"
