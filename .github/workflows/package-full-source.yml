name: Package Source + Submodules â†’ Release (No History)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      notes:
        description: 'Release notes (optional)'
        required: false

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Remove all Git-related files and directories
        run: |
          echo "ğŸ—‘ï¸ Removing .git directories and Git config files..."
          rm -rf .git
          find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          rm -f .gitmodules .gitignore .gitattributes .mailmap

      - name: Show directory structure BEFORE packing
        run: |
          echo "ğŸ” Files and folders that will be packed:"
          ls -laR

      - name: Create clean source archive safely
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          TAG="${{ github.event.inputs.tag }}"
          SAFE_TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]/-/g')
          ARCHIVE_NAME="${REPO_NAME}-${SAFE_TAG}.tar.gz"

          echo "ğŸ“¦ Creating archive: $ARCHIVE_NAME"
          sleep 2

          mkdir -p /tmp/clean-repo
          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitmodules' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='.editorconfig' \
            --exclude='.vscode' \
            --exclude='.idea' \
            --exclude='.devcontainer' \
            --exclude='.azurepipelines' \
            --exclude='.mergify' \
            --exclude='.pytool' \
            --exclude='.env' \
            --exclude='.DS_Store' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='build' \
            --exclude='dist' \
            --exclude='*.log' \
            --exclude='Thumbs.db' \
            . /tmp/clean-repo/

          cd /tmp/clean-repo
          tar --transform "s,^,${REPO_NAME}-${SAFE_TAG}/," -czf "../$ARCHIVE_NAME" .

          mv "../$ARCHIVE_NAME" .
          echo "âœ… Archive created: $ARCHIVE_NAME"

          # âœ… å¯¼å‡ºåˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 10  # è‡ªåŠ¨è¶…æ—¶æ–­å¼€

      - name: Continue other steps (won't run until you exit tmate)
        run: |
          echo "You won't see this until you exit the tmate session!"

          
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.tag }}
          release_name: Release ${{ github.event.inputs.tag }}
          body: ${{ github.event.inputs.notes || 'Automated source package with submodules (no Git history)' }}
          draft: false
          prerelease: false

      - name: Upload custom archive to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /tmp/clean-repo/${{ env.ARCHIVE_NAME }}
          asset_name: ${{ env.ARCHIVE_NAME }}  # âœ… ç°åœ¨å¯ä»¥ç”¨äº†
          asset_content_type: application/gzip
