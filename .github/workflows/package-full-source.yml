# @file BuildPlatform.yml
#
# A reusable workflow that builds an EDKII platform and uploads it's artifacts.
#
##
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: BSD-2-Clause-Patent
##

name: my self Build Platform

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      notes:
        description: 'Release notes (optional)'
        required: false

      python-version:
        required: true
        description: 'The version of Python to use for the job'
        type: string
        default: '3.12'
      runs-on:
        required: true
        description: 'The runner type to use for the job'
        type: string
        default: 'ubuntu-latest'
      build-file:
        required: true
        description: 'The path to the stuart build script'
        type: string
        default: 'UefiPayloadPkg/PlatformCI/PlatformBuild.py'
      tool-chain:
        required: true
        description: 'The tool chain to use for the build'
        type: string
        default: 'GCC'
      target:
        required: true
        description: 'The target to build'
        type: string
        default: 'DEBUG'
      extra-build-args:
        required: false
        description: 'Extra arguments to pass to the build script'
        type: string
        default: 'FIT_BUILD=FALSE'
      extra-pip-requirements:
        required: false
        description: 'Extra pip requirements to install'
        type: string
        default: 'pefile pylibfdt'
      extra-setup-cmd:
        required: false
        description: 'Extra setup commands to run'
        type: string
        default: 'sudo dnf install -y llvm clang llvm-libs llvm-devel lldb'
      extra-artifact-path:
        required: false
        description: 'Extra artifact paths to upload'
        type: string
        default: ''

jobs:
  build:
    name: my Build Platform

    runs-on: ${{ inputs.runs-on }}
    container:
      image: ${{ startswith(inputs.runs-on, 'ubuntu') && 'ghcr.io/tianocore/containers/fedora-40-dev:latest' || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - run: |
          git config --global --add safe.directory '*'
        name: 'Set Safe Directory'
        if: ${{ startsWith(inputs.runs-on, 'ubuntu') }}

      - name: Set up Python ${{ inputs.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ inputs.python-version }}
        if: ${{ !startsWith(inputs.runs-on, 'ubuntu') }}

      - run: |
          pip install --upgrade ${{ inputs.extra-pip-requirements }} -r pip-requirements.txt
        name: 'Install/Upgrade pip modules'

      - run: ${{ inputs.extra-setup-cmd }}
        name: 'Extra Setup Commands'
        if: ${{ inputs.extra-setup-cmd != '' }}

      - run: |
          stuart_setup -c ${{ inputs.build-file }}
        name: 'Clone Submodules'

      - run: |
          stuart_update -c ${{ inputs.build-file }}
        name: 'Download External Dependencies'




      - name: set ARCHIVE_NAME
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          TAG="${{ github.event.inputs.tag }}"
          SAFE_TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]/-/g')
          ARCHIVE_NAME="${REPO_NAME}-${SAFE_TAG}.tar.gz"
          echo "ğŸ“¦ Creating archive: $ARCHIVE_NAME"

          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV


          mkdir -p /tmp/clean-repo
          sleep 2
          ls -al
          tar -czvf "/tmp/clean-repo/$ARCHIVE_NAME" .

      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3
      #   timeout-minutes: 10  # è‡ªåŠ¨è¶…æ—¶æ–­å¼€



      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.tag }}
          release_name: Release ${{ github.event.inputs.tag }}
          body: ${{ github.event.inputs.notes || 'Automated source package with submodules (no Git history)' }}
          draft: false
          prerelease: false

      - name: Upload custom archive to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /tmp/clean-repo/${{ env.ARCHIVE_NAME }}
          asset_name: ${{ env.ARCHIVE_NAME }}  # âœ… ç°åœ¨å¯ä»¥ç”¨äº†
          asset_content_type: application/gzip
