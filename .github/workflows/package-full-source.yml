name: Package Source & Submodules ‚Üí Release (No History)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      notes:
        description: 'Release notes'
        required: false

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ÂøÖÈ°ªÔºÅÁî®‰∫éÂàõÂª∫ Release

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1  # ÊµÖÂÖãÈöÜÔºåÂä†Âø´ÈÄüÂ∫¶

      - name: Remove all .git directories (no history)
        run: |
          echo "üóëÔ∏è Removing .git directories..."
          rm -rf .git
          find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true

      - name: Show directory structure BEFORE packing
        run: |
          echo "üîç Files and folders that will be packed:"
          ls -laR

      - name: Create clean source archive
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          TAG="${{ github.event.inputs.tag }}"
          # Ê∏ÖÁêÜ tag ‰∏≠ÁöÑÈùûÊ≥ïÂ≠óÁ¨¶
          SAFE_TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]/-/g')
          ARCHIVE_NAME="${REPO_NAME}-${SAFE_TAG}.tar.gz"

          echo "üì¶ Creating archive: $ARCHIVE_NAME"

          tar \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='.DS_Store' \
            --exclude='*.log' \
            --exclude='.vscode' \
            --exclude='.idea' \
            --exclude='build' \
            --exclude='dist' \
            --transform "s,^,${REPO_NAME}-${SAFE_TAG}/," \
            -czf "$ARCHIVE_NAME" .

          echo "‚úÖ Archive created successfully."

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: Release ${{ github.event.inputs.tag }}
          body: ${{ github.event.inputs.notes || 'Automated source package (no git history)' }}
          files: "*.tar.gz"
