name: Package Source + Submodules â†’ Release (No History)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      notes:
        description: 'Release notes (optional)'
        required: false

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Set up absolute paths
        id: paths
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          WORKSPACE="/home/runner/work/$REPO_NAME/$REPO_NAME"
          echo "WORKSPACE=$WORKSPACE" >> $GITHUB_ENV
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

      - name: Remove all Git-related files and directories
        run: |
          echo "ðŸ—‘ï¸ Removing .git directories and Git config files..."
          rm -rf .git
          find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          rm -f .gitmodules .gitignore .gitattributes .mailmap

      - name: Show directory structure BEFORE packing
        run: |
          echo "ðŸ” Files and folders that will be packed:"
          ls -laR

      - name: Create clean source archive using absolute paths
        run: |
          REPO_NAME="${{ env.REPO_NAME }}"
          TAG="${{ github.event.inputs.tag }}"
          SAFE_TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]/-/g')
          ARCHIVE_NAME="${REPO_NAME}-${SAFE_TAG}.tar.gz"
          WORKSPACE="${{ env.WORKSPACE }}"

          CLEAN_DIR="/tmp/clean-repo"
          ARCHIVE_PATH="$WORKSPACE/$ARCHIVE_NAME"

          echo "ðŸ“¦ REPO_NAME: $REPO_NAME"
          echo "ðŸ“¦ TAG: $TAG"
          echo "ðŸ“¦ SAFE_TAG: $SAFE_TAG"
          echo "ðŸ“¦ ARCHIVE_NAME: $ARCHIVE_NAME"
          echo "ðŸ“¦ WORKSPACE: $WORKSPACE"
          echo "ðŸ“¦ CLEAN_DIR: $CLEAN_DIR"
          echo "ðŸ“¦ ARCHIVE_PATH: $ARCHIVE_PATH"

          # ç¡®ä¿å·¥ä½œåŒºå¹²å‡€
          mkdir -p "$CLEAN_DIR"

          # åŒæ­¥å½“å‰ç›®å½•åˆ°ä¸´æ—¶ç›®å½•ï¼ˆæŽ’é™¤ä¸éœ€è¦çš„ï¼‰
          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitmodules' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='.editorconfig' \
            --exclude='.vscode' \
            --exclude='.idea' \
            --exclude='.devcontainer' \
            --exclude='.azurepipelines' \
            --exclude='.mergify' \
            --exclude='.pytool' \
            --exclude='.env' \
            --exclude='.DS_Store' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='build' \
            --exclude='dist' \
            --exclude='*.log' \
            --exclude='Thumbs.db' \
            "$WORKSPACE/" "$CLEAN_DIR/"

          # æ‰“åŒ…ï¼šæ·»åŠ é¡¶å±‚ç›®å½•å
          cd "$CLEAN_DIR"
          tar --transform "s,^,${REPO_NAME}-${SAFE_TAG}/," -czf "$ARCHIVE_PATH" .

          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$ARCHIVE_PATH" ]; then
            echo "âŒ Failed to create archive at: $ARCHIVE_PATH"
            exit 1
          fi

          echo "âœ… Archive created successfully at: $ARCHIVE_PATH"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV

      - name: Debug: Confirm archive exists
        run: |
          ls -lh "${{ env.ARCHIVE_PATH }}"
          file "${{ env.ARCHIVE_PATH }}"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          release_name: Release ${{ github.event.inputs.tag }}
          body: ${{ github.event.inputs.notes || 'Automated source package with submodules (no Git history)' }}
          draft: false
          prerelease: false

      - name: Upload custom archive to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.ARCHIVE_PATH }}
          asset_name: ${{ env.ARCHIVE_NAME }}
          asset_content_type: application/gzip
